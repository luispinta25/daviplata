<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#40403F">
  <meta name="description" content="DaviPlata - Sistema de Control de Movimientos">

  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DaviPlata">
  <link rel="apple-touch-icon" href="https://i.ibb.co/FLFGvTNp/DAVIPLATALOGO.png">

  <title>DaviPlata - Control de Movimientos</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/FLFGvTNp/DAVIPLATALOGO.png">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- QR Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <!-- ============================================
       LOGIN SCREEN
       ============================================ -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <img src="https://i.ibb.co/FLFGvTNp/DAVIPLATALOGO.png" alt="DaviPlata" class="login-logo">
        <p class="login-subtitle">Sistema de Control de Movimientos</p>
      </div>

      <!-- Login Form -->
      <div class="auth-form-container">
        <h2 class="auth-title">Iniciar Sesión</h2>
        <form id="login-form" class="auth-form">
          <div class="form-group">
            <label class="form-label" for="login-email">
              <i class="fas fa-envelope"></i> Correo electrónico
            </label>
            <input type="email" class="form-input" id="login-email" placeholder="tu@email.com" required
              autocomplete="email">
          </div>

          <div class="form-group">
            <label class="form-label" for="login-password">
              <i class="fas fa-lock"></i> Contraseña
            </label>
            <div class="password-input-wrapper">
              <input type="password" class="form-input" id="login-password" placeholder="••••••••" required
                autocomplete="current-password">
              <button type="button" class="password-toggle" id="toggle-password" tabindex="-1">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block btn-lg">
            <i class="fas fa-sign-in-alt"></i> Ingresar
          </button>
        </form>
      </div>

      <div class="login-footer">
        <i class="fas fa-shield-alt"></i> Conexión segura
      </div>
    </div>
  </div>

  <!-- ============================================
       APP SCREEN
       ============================================ -->
  <div id="app-screen" class="app-container" style="display: none;">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-brand">
          <img src="https://i.ibb.co/FLFGvTNp/DAVIPLATALOGO.png" alt="DaviPlata" class="logo">
        </div>
        <div class="header-user">
          <div class="user-info">
            <span class="user-name" id="user-name">Usuario</span>
            <span class="role-badge" id="role-badge">User</span>
          </div>
        </div>
        <div class="header-actions">
          <button class="header-btn" id="btn-pdf" title="Exportar PDF">
            <i class="fas fa-file-pdf"></i>
          </button>
          <button class="header-btn logout" id="btn-logout" title="Cerrar sesión">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Balance Card -->
      <div class="balance-card slide-up">
        <div class="balance-header">
          <i class="fas fa-wallet"></i>
          <span>Balance Disponible</span>
        </div>
        <div class="balance-amount" id="balance-amount">$ 0</div>
        
        <!-- Saldo por verificar (oculto por defecto) -->
        <div id="pending-balance-container" class="pending-balance-container" style="display: none;">
          <i class="fas fa-clock"></i>
          <span>Por verificar: </span>
          <span id="pending-balance-amount">$ 0</span>
        </div>

        <div class="balance-stats">
          <div class="stat-item income">
            <div class="stat-icon">
              <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">Ingresos</div>
              <div class="stat-value" id="income-stat">$ 0</div>
            </div>
          </div>
          <div class="stat-item expense">
            <div class="stat-icon">
              <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">Egresos</div>
              <div class="stat-value" id="expense-stat">$ 0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <button class="filter-btn active" data-filter="TODOS">
          <i class="fas fa-list"></i> Todos
        </button>
        <button class="filter-btn" data-filter="INGRESO">
          <i class="fas fa-arrow-down"></i> Ingresos
        </button>
        <button class="filter-btn" data-filter="EGRESO">
          <i class="fas fa-arrow-up"></i> Egresos
        </button>
      </div>

      <!-- Movements Section -->
      <section class="section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-history"></i> Movimientos Recientes
          </h2>
        </div>
        <div class="movements-list" id="movements-list">
          <!-- Movimientos se cargarán aquí -->
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="empty-state-title">Cargando...</div>
          </div>
        </div>
      </section>
    </main>

    <!-- FAB Buttons -->
    <div class="fab-container">
      <button class="fab income" id="fab-income" title="Registrar Ingreso">
        <i class="fas fa-plus"></i>
      </button>
      <button class="fab expense" id="fab-expense" title="Registrar Egreso">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- ============================================
       MODAL: Nuevo/Editar Movimiento
       ============================================ -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">
          <i class="fas fa-plus-circle"></i> Nuevo Movimiento
        </h2>
        <button class="modal-close" id="modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="movement-form">
        <div class="modal-body">
          <!-- Tipo de Movimiento -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-exchange-alt"></i> Tipo de Movimiento
            </label>
            <div class="type-selector">
              <div class="type-option income" data-type="INGRESO">
                <i class="fas fa-arrow-down"></i>
                <span>Ingreso</span>
              </div>
              <div class="type-option expense" data-type="EGRESO">
                <i class="fas fa-arrow-up"></i>
                <span>Egreso</span>
              </div>
            </div>
          </div>

          <!-- Monto -->
          <div class="form-group">
            <label class="form-label" for="input-monto">
              <i class="fas fa-dollar-sign"></i> Monto (USD)
            </label>
            <input type="number" class="form-input form-input-amount" id="input-monto" placeholder="0.00" min="0.01"
              step="0.01" required>
          </div>

          <!-- Motivo -->
          <div class="form-group">
            <label class="form-label" for="input-motivo">
              <i class="fas fa-align-left"></i> Motivo / Descripción
            </label>
            <textarea class="form-input" id="input-motivo" placeholder="Describe el motivo del movimiento..." rows="3"
              required></textarea>
          </div>

          <!-- Comprobante -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-paperclip"></i> Comprobante (opcional)
            </label>
            <div class="upload-options">
              <div class="upload-option-item" id="opt-camera">
                <i class="fas fa-camera"></i>
                <span>Cámara</span>
                <input type="file" id="file-camera" accept="image/*" capture="environment">
              </div>
              <div class="upload-option-item" id="opt-gallery">
                <i class="fas fa-images"></i>
                <span>Galería</span>
                <input type="file" id="file-gallery" accept="image/*">
              </div>
            </div>
            <div id="file-preview-container"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-check"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================
       MODAL: Detalle de Movimiento
       ============================================ -->
  <div class="modal-overlay" id="detail-modal-overlay">
    <div class="modal" id="detail-modal-content">
      <!-- Contenido se carga dinámicamente -->
    </div>
  </div>

  <!-- ============================================
       MODAL: Confirmación Personalizada
       ============================================ -->
  <div class="modal-overlay" id="confirm-modal-overlay">
    <div class="modal confirm-modal">
      <div class="modal-body confirm-modal-body">
        <div class="confirm-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <h3 id="confirm-title">¿Estás seguro?</h3>
        <p id="confirm-message">Esta acción actualizará el saldo y enviará una notificación.</p>
        <div class="confirm-actions">
          <button class="btn btn-secondary" id="confirm-cancel">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="btn btn-primary" id="confirm-ok">
            <i class="fas fa-check"></i> Sí, continuar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================
       MODAL: Opciones de Reporte PDF
       ============================================ -->
  <div class="modal-overlay" id="pdf-modal-overlay">
    <div class="modal pdf-modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-file-pdf"></i> Exportar Reporte
        </h2>
        <button class="modal-close" onclick="closePdfModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Filtros Rápidos -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-filter"></i> Tipo de Movimientos
          </label>
          <div class="pdf-filter-grid">
            <label class="filter-chip">
              <input type="radio" name="pdf-type" value="TODOS" checked>
              <span><i class="fas fa-list"></i> Todos</span>
            </label>
            <label class="filter-chip">
              <input type="radio" name="pdf-type" value="INGRESO">
              <span><i class="fas fa-arrow-down"></i> Ingresos</span>
            </label>
            <label class="filter-chip">
              <input type="radio" name="pdf-type" value="EGRESO">
              <span><i class="fas fa-arrow-up"></i> Egresos</span>
            </label>
          </div>
        </div>

        <!-- Rango de Fechas -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-calendar-alt"></i> Rango de Fechas
          </label>
          <div class="date-range-grid">
            <div class="date-input-group">
              <span class="date-label">Desde</span>
              <input type="date" class="form-input" id="pdf-date-start">
            </div>
            <div class="date-input-group">
              <span class="date-label">Hasta</span>
              <input type="date" class="form-input" id="pdf-date-end">
            </div>
          </div>
        </div>

        <!-- Modo de Salida -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-print"></i> Modo de Reporte
          </label>
          <div class="pdf-output-grid">
            <label class="output-option">
              <input type="radio" name="pdf-mode" value="device" checked>
              <div class="output-content">
                <i class="fas fa-mobile-alt"></i>
                <div class="output-text">
                  <div class="output-title">Dispositivo</div>
                  <div class="output-desc">Incluye enlaces clicables</div>
                </div>
              </div>
            </label>
            <label class="output-option">
              <input type="radio" name="pdf-mode" value="print">
              <div class="output-content">
                <i class="fas fa-print"></i>
                <div class="output-text">
                  <div class="output-title">Impresora</div>
                  <div class="output-desc">Incluye códigos QR</div>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePdfModal()">
          <i class="fas fa-times"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary btn-block" id="btn-generate-pdf">
          <i class="fas fa-file-pdf"></i> Generar Reporte
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/config.js?v=2"></script>
  <script src="js/supabase.js?v=2"></script>
  <script src="js/upload.js?v=2"></script>
  <script src="js/movements.js?v=2"></script>
  <script src="js/pdf.js?v=5"></script>
  <script src="js/app.js?v=2"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registrado correctamente'))
          .catch(err => console.warn('Error al registrar Service Worker', err));
      });
    }
  </script>
</body>

</html>